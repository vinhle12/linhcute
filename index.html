<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Galaxy Heart</title>
  <style>
    body,html {
      margin:0; padding:0; overflow:hidden; background:black;
      height:100%; width:100%;
      font-family: "Comic Sans MS", cursive, sans-serif;
    }
    #flash {
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:white;
      opacity:0;
      pointer-events:none;
      transition:opacity 1s;
      z-index:5;
    }
    #heartCanvas {
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      display:none;
      z-index:10;
    }
    #loveText {
      position:fixed;
      bottom:10%;
      width:100%;
      text-align:center;
      font-size:32px;
      font-weight:bold;
      color:#ff5ca4;
      opacity:0;
      z-index:20;
      animation: fadeIn 3s forwards, pulse 2s infinite;
    }
    @keyframes fadeIn {
      from {opacity:0; transform:translateY(20px);}
      to {opacity:1; transform:translateY(0);}
    }
    @keyframes pulse {
      0% {transform:scale(1);}
      50% {transform:scale(1.05);}
      100% {transform:scale(1);}
    }
  </style>
</head>
<body>
  <div id="flash"></div>
  <canvas id="heartCanvas"></canvas>
  <div id="loveText">Linh ngoan xinh yÃªu cá»§a tá»› ngá»§ ngon nha ðŸ’–</div>
  <script type="module">
    import * as THREE from "https://cdn.skypack.dev/three@0.136.0";
    import { OrbitControls } from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls";

    // ====== Galaxy Scene ======
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
    camera.position.set(0,0,80);

    let renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(innerWidth, innerHeight);
    document.body.appendChild(renderer.domElement);

    let controls = new OrbitControls(camera, renderer.domElement);

    // star glow texture
    const starTexture = new THREE.TextureLoader().load("https://threejs.org/examples/textures/sprites/disc.png");

    // particles
    let starGeo = new THREE.BufferGeometry();
    let positions = [];
    let colors = [];
    let sizes = [];
    for (let i=0;i<8000;i++){
      positions.push((Math.random()-0.5)*1000);
      positions.push((Math.random()-0.5)*1000);
      positions.push((Math.random()-0.5)*1000);

      let color = new THREE.Color();
      color.setHSL(Math.random()*0.6+0.4, 1, 0.6);
      colors.push(color.r,color.g,color.b);

      sizes.push(Math.random()*15+5);
    }
    starGeo.setAttribute("position", new THREE.Float32BufferAttribute(positions,3));
    starGeo.setAttribute("color", new THREE.Float32BufferAttribute(colors,3));
    starGeo.setAttribute("size", new THREE.Float32BufferAttribute(sizes,1));

    let starMat = new THREE.PointsMaterial({
      size:6,
      map:starTexture,
      transparent:true,
      vertexColors:true,
      blending:THREE.AdditiveBlending,
      depthWrite:false
    });

    let stars = new THREE.Points(starGeo,starMat);
    scene.add(stars);

    // Core star
    let core = new THREE.Mesh(
      new THREE.SphereGeometry(6,32,32),
      new THREE.MeshBasicMaterial({color:0xff66ff})
    );
    core.name="starCore";
    scene.add(core);

    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();

    // ====== Heart canvas (hidden first) ======
    let heartCanvas = document.getElementById("heartCanvas");
    let heartCtx = heartCanvas.getContext("2d");
    heartCanvas.width = innerWidth;
    heartCanvas.height = innerHeight;

    var settings = {
      particles:{length:2000,duration:2,velocity:100,effect:-1.3,size:13}
    };
    function Point(x,y){this.x=x||0;this.y=y||0;}
    Point.prototype.clone=function(){return new Point(this.x,this.y);}
    Point.prototype.length=function(l){if(l===undefined)return Math.sqrt(this.x*this.x+this.y*this.y);
      this.normalize();this.x*=l;this.y*=l;return this;}
    Point.prototype.normalize=function(){var l=this.length();this.x/=l;this.y/=l;return this;}

    function Particle(){this.position=new Point();this.velocity=new Point();this.acceleration=new Point();this.age=0;}
    Particle.prototype.initialize=function(x,y,dx,dy){
      this.position.x=x;this.position.y=y;this.velocity.x=dx;this.velocity.y=dy;
      this.acceleration.x=dx*settings.particles.effect;
      this.acceleration.y=dy*settings.particles.effect;this.age=0;}
    Particle.prototype.update=function(dt){
      this.position.x+=this.velocity.x*dt;
      this.position.y+=this.velocity.y*dt;
      this.velocity.x+=this.acceleration.x*dt;
      this.velocity.y+=this.acceleration.y*dt;
      this.age+=dt;}
    Particle.prototype.draw=function(ctx,img){
      function ease(t){return (--t)*t*t+1;}
      var size=img.width*ease(this.age/settings.particles.duration);
      ctx.globalAlpha=1-this.age/settings.particles.duration;
      ctx.drawImage(img,this.position.x-size/2,this.position.y-size/2,size,size);
    };

    function ParticlePool(length){
      var particles=new Array(length);
      for(let i=0;i<length;i++)particles[i]=new Particle();
      var firstActive=0,firstFree=0,duration=settings.particles.duration;
      this.add=function(x,y,dx,dy){
        particles[firstFree].initialize(x,y,dx,dy);
        firstFree=(firstFree+1)%length;
        if(firstActive===firstFree)firstActive=(firstActive+1)%length;};
      this.update=function(dt){
        for(let i=firstActive;i!=firstFree;i=(i+1)%length)particles[i].update(dt);
        while(particles[firstActive].age>=duration&&firstActive!==firstFree){
          firstActive=(firstActive+1)%length;}
      };
      this.draw=function(ctx,img){
        for(let i=firstActive;i!=firstFree;i=(i+1)%length)particles[i].draw(ctx,img);
      };
    }

    function pointOnHeart(t){
      return new Point(
        160*Math.pow(Math.sin(t),3),
        130*Math.cos(t)-50*Math.cos(2*t)-20*Math.cos(3*t)-10*Math.cos(4*t)+25
      );
    }

    var image=(function(){
      var c=document.createElement("canvas"),ctx=c.getContext("2d");
      c.width=settings.particles.size;c.height=settings.particles.size;
      function to(t){
        var p=pointOnHeart(t);
        p.x=settings.particles.size/2+p.x*settings.particles.size/350;
        p.y=settings.particles.size/2-p.y*settings.particles.size/350;
        return p;}
      ctx.beginPath();var t=-Math.PI,p=to(t);ctx.moveTo(p.x,p.y);
      while(t<Math.PI){t+=0.01;p=to(t);ctx.lineTo(p.x,p.y);}
      ctx.closePath();ctx.fillStyle="#FF5CA4";ctx.fill();
      var img=new Image();img.src=c.toDataURL();return img;
    })();

    var particles=new ParticlePool(settings.particles.length);
    var particleRate=settings.particles.length/settings.particles.duration;
    var time;

    function heartRender(){
      requestAnimationFrame(heartRender);
      var newTime=new Date().getTime()/1000;
      var dt=newTime-(time||newTime);time=newTime;
      heartCtx.clearRect(0,0,heartCanvas.width,heartCanvas.height);
      var amount=particleRate*dt;
      for(var i=0;i<amount;i++){
        var pos=pointOnHeart(Math.PI-2*Math.PI*Math.random());
        var dir=pos.clone().length(settings.particles.velocity);
        particles.add(heartCanvas.width/2+pos.x,heartCanvas.height/2-pos.y,dir.x,-dir.y);
      }
      particles.update(dt);
      particles.draw(heartCtx,image);
    }

    // ====== Interaction ======
    let flash=document.getElementById("flash");
    let galaxyActive=true;
    let loveText=document.getElementById("loveText");
    loveText.style.display="none";

    window.addEventListener("click",(e)=>{
      mouse.x=(e.clientX/innerWidth)*2-1;
      mouse.y=-(e.clientY/innerHeight)*2+1;
      raycaster.setFromCamera(mouse,camera);
      let hits=raycaster.intersectObjects([core]);
      if(hits.length>0 && galaxyActive){
        triggerFlash();
      }
    });

    function triggerFlash(){
      flash.style.transition="none";
      flash.style.opacity=1;
      setTimeout(()=>{
        flash.style.transition="opacity 1s";
        flash.style.opacity=0;
        renderer.domElement.style.display="none";
        heartCanvas.style.display="block";
        heartRender();
        setTimeout(()=>{ loveText.style.display="block"; },2000);
      },200);
      galaxyActive=false;
    }

    // ====== Animate galaxy ======
    function animate(){
      if(galaxyActive){
        requestAnimationFrame(animate);
        stars.rotation.y+=0.0003;
        stars.rotation.x+=0.0001;
        let positions=starGeo.attributes.position.array;
        for(let i=0;i<positions.length;i+=3){
          let dist=Math.sqrt(positions[i]*positions[i]+positions[i+1]*positions[i+1]+positions[i+2]*positions[i+2]);
          positions[i+2]+=Math.sin(Date.now()*0.001+i)*0.01;
        }
        starGeo.attributes.position.needsUpdate=true;
        renderer.render(scene,camera);
      }
    }
    animate();

  </script>
</body>
</html>
